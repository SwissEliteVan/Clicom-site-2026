---
import "../styles/global.css";
import { site } from "../lib/site";

export type BaseLayoutProps = {
  title: string;
  description: string;
  canonical?: string;
  lang?: string;
  breadcrumbs?: { name: string; item: string }[];
  jsonLd?: Record<string, unknown>[];
};

const {
  title,
  description,
  canonical = site.url,
  lang = "fr",
  breadcrumbs,
  jsonLd = [],
} = Astro.props;

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "ProfessionalService",
  name: site.name,
  url: site.url,
  description: site.slogan,
  email: site.email,
  telephone: site.phone,
  areaServed: "CH",
};

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: site.name,
  url: site.url,
  potentialAction: {
    "@type": "SearchAction",
    target: `${site.url}/blog/?q={search_term_string}`,
    "query-input": "required name=search_term_string",
  },
};

const breadcrumbSchema = breadcrumbs
  ? {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      itemListElement: breadcrumbs.map((crumb, index) => ({
        "@type": "ListItem",
        position: index + 1,
        name: crumb.name,
        item: `${site.url}${crumb.item}`,
      })),
    }
  : null;

const schemas = [organizationSchema, websiteSchema, breadcrumbSchema, ...jsonLd].filter(
  Boolean
);
---
<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonical} />
    <meta property="og:site_name" content={site.name} />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="theme-color" content={site.accent} />
    {schemas.length > 0 && (
      <script type="application/ld+json">{JSON.stringify(schemas)}</script>
    )}
  </head>
  <body class="min-h-screen bg-white text-ink">
    <slot />

    <div
      id="cookie-banner"
      class="fixed bottom-4 left-4 right-4 z-50 hidden max-w-xl rounded-2xl border border-black/10 bg-white p-4 shadow-soft"
      role="dialog"
      aria-live="polite"
      aria-label="Préférences cookies"
    >
      <div class="flex flex-col gap-3 text-sm">
        <p>
          Nous n'utilisons aucun tracking par défaut. Activez l'analytics si vous
          souhaitez aider à améliorer le site.
        </p>
        <div class="flex flex-wrap gap-2">
          <button
            class="focus-ring rounded-full bg-ink px-4 py-2 text-white"
            data-cookie-accept
            type="button"
          >
            Accepter analytics
          </button>
          <button
            class="focus-ring rounded-full border border-ink px-4 py-2"
            data-cookie-decline
            type="button"
          >
            Refuser
          </button>
          <a class="focus-ring text-accent underline" href="/cookies/"
            >En savoir plus</a
          >
        </div>
      </div>
    </div>

    <script is:inline>
      const banner = document.getElementById("cookie-banner");
      const consentKey = "clicom-analytics-consent";
      const stored = localStorage.getItem(consentKey);
      if (!stored && banner) {
        banner.classList.remove("hidden");
      }
      document
        .querySelector("[data-cookie-accept]")
        ?.addEventListener("click", () => {
          localStorage.setItem(consentKey, "accepted");
          banner?.classList.add("hidden");
          // Analytics loading example (keep commented until used)
          // if (window.gtag) return;
        });
      document
        .querySelector("[data-cookie-decline]")
        ?.addEventListener("click", () => {
          localStorage.setItem(consentKey, "declined");
          banner?.classList.add("hidden");
        });
    </script>
  </body>
</html>
